<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="utf-8">
<title>Pregled ePD (FS 3.11 – svi skupovi pregleda)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --bg:#f6f9f5; --card:#ffffff; --ink:#203229; --muted:#5e6b63;
  --accent:#4da657; --accent-2:#2f7d32; --border:#e3e9e5;
  --shadow:0 10px 28px rgba(32,50,41,.08); --radius:14px;
}
*{box-sizing:border-box}
body{margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--ink); background:var(--bg)}
.wrap{max-width:1240px; margin:auto; padding:24px}
h1{margin:0 0 8px; color:var(--accent-2); font-size:26px}
h2{margin:0; font-size:18px}
.hint{font-size:12px; color:var(--muted)}

/* Toolbar */
.toolbar{position:sticky; top:0; z-index:30; background:linear-gradient(180deg,var(--bg),#fff); border-bottom:1px solid var(--border); padding:12px 0}
.filters{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.field{display:flex; align-items:center; background:#fff; border:1px solid var(--border); border-radius:12px; padding:9px 12px; box-shadow:var(--shadow)}
select,input{border:0; outline:0; background:transparent; color:var(--ink); font-size:15px}
.btn{appearance:none; border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; border:1px solid var(--border); background:#fff; color:#41504a}
.btn:disabled{opacity:.6; cursor:not-allowed}

/* Cards */
.card{background:#fff; border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); margin-top:14px}
.card-header{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 16px; border-bottom:1px dashed var(--border)}
.card-body{padding:16px}

/* Tables */
table{width:100%; border-collapse:separate; border-spacing:0; border:1px solid var(--border); border-radius:12px}
th,td{padding:10px 12px; text-align:left}
thead th{background:linear-gradient(180deg,rgba(47,125,50,.08),transparent); border-bottom:1px solid var(--border); white-space:nowrap}
tbody tr+tr td{border-top:1px dashed var(--border)}
tbody tr:hover{background:#f3f8f4}
.link{color:#0b5f8a; text-decoration:none}
.link:hover{text-decoration:underline}

/* Badges */
.badge{display:inline-block; padding:.18rem .5rem; border-radius:999px; border:1px solid var(--border); font-size:12px}
.b-aktivan{background:#fff}
.b-sender{background:#eaf6ff; color:#0b5f8a; border-color:#bfe4ff}
.b-finish{background:#e9f7ee; color:#1e6d3a; border-color:#c8ebd3}
.b-storno{background:#fdeaea; color:#9b1f1f; border-color:#f4c4c4}

/* Layout */
.grid2{display:grid; grid-template-columns:1fr 1fr; gap:16px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Pregled ePD</h1>
  <div class="hint">FS 3.11 (PSK004: Pregled po Pošiljatelju/Primatelju + zbirni pregledi i dostupne količine). Filtri utječu i na zbirne tablice.</div>

  <!-- FILTERI -->
  <div class="toolbar">
    <div class="filters">
      <div class="field">
        <select id="fYear">
          <option value="">Godina kreiranja</option>
          <option>2023</option>
          <option>2024</option>
          <option selected>2025</option>
          <option>2026</option>
        </select>
      </div>
      <div class="field">
        <select id="fWine">
          <option value="">Vinska godina</option>
          <option>2023/2024</option>
          <option selected>2024/2025</option>
          <option>2025/2026</option>
        </select>
      </div>
      <div class="field">
        <select id="fType">
          <option value="">Vrsta robe</option>
          <option value="grozdje">Grožđe</option>
          <option value="rinfuza">Vinski proizvod (rinfuza)</option>
          <option value="pretpakovine">Pretpakovine</option>
          <option value="ocat">Vinski ocat</option>
        </select>
      </div>
      <div class="field">
        <select id="fStatus">
          <option value="">Status</option>
          <option>Aktivan</option>
          <option>Elektronički potpisan (pošiljatelj)</option>
          <option>Završen</option>
          <option>Storniran</option>
        </select>
      </div>
      <div class="field">
        <input id="fRef" placeholder="MVV ili naziv (pošilj./prim.)" />
      </div>
      <button class="btn" id="btnSearch">Pretraži</button>
      <button class="btn" id="btnReset">Poništi</button>
    </div>
  </div>

  <!-- POŠILJATELJ -->
  <div class="card">
    <div class="card-header"><h2>Pošiljatelj</h2></div>
    <div class="card-body">
      <table id="tblS">
        <thead>
          <tr>
            <th>Ref. broj (MVV)</th>
            <th>Vrsta robe</th>
            <th>Kategorija / Sorta</th>
            <th>Dodatni podaci</th>
            <th>Količina</th>
            <th>Datum i vrijeme kreiranja</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="hint" id="hintS" style="margin-top:6px"></div>
    </div>
  </div>

  <!-- PRIMATELJ -->
  <div class="card">
    <div class="card-header"><h2>Primatelj</h2></div>
    <div class="card-body">
      <table id="tblR">
        <thead>
          <tr>
            <th>Ref. broj (MVV)</th>
            <th>Vrsta robe</th>
            <th>Kategorija / Sorta</th>
            <th>Dodatni podaci</th>
            <th>Količina</th>
            <th>Datum i vrijeme kreiranja</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="hint" id="hintR" style="margin-top:6px"></div>
    </div>
  </div>

  <!-- ZBIRNI PREGLEDI -->
  <div class="grid2">
    <!-- Ukupno – Grožđe -->
    <div class="card">
      <div class="card-header">
        <h2>Ukupno prevezene količine – Grožđe (po sortama)</h2>
        <span class="hint">u tonama, samo filtrirani zapisi</span>
      </div>
      <div class="card-body">
        <table id="sumG">
          <thead><tr><th>Sorta</th><th>Količina (t)</th><th>Broj ePD-ova</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Ukupno – Mošt/Vino -->
    <div class="card">
      <div class="card-header">
        <h2>Ukupno prevezene količine – Mošt/Vino</h2>
        <span class="hint">u hektolitrima: crno/roze i bijelo</span>
      </div>
      <div class="card-body">
        <table id="sumMV">
          <thead><tr><th>Vino/Mošt</th><th>Crno/roze (hl)</th><th>Bijelo (hl)</th><th>Broj ePD-ova</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Vinski ocat + Dostupne količine -->
  <div class="grid2">
    <!-- Ukupno – Vinski ocat -->
    <div class="card">
      <div class="card-header">
        <h2>Ukupno prevezene količine – Vinski ocat</h2>
        <span class="hint">u hektolitrima</span>
      </div>
      <div class="card-body">
        <table id="sumOcat">
          <thead><tr><th>Kategorija</th><th>Ukupno (hl)</th><th>Broj ePD-ova</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Dostupne količine – Grožđe -->
    <div class="card">
      <div class="card-header">
        <h2>Dostupne količine – Grožđe</h2>
        <span class="hint">Iz Izjave o očekivanoj berbi / Izjave o berbi (informativno)</span>
      </div>
      <div class="card-body">
        <table id="availG">
          <thead><tr><th>Sorta</th><th>Količina (t)</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
/* ========= DUMMY PODACI =========
   Polja:
   - role: 'sender' | 'receiver'
   - mvv: 'broj/godina'
   - vg: '2023/2024' | '2024/2025' | '2025/2026'
   - year: '2023' | '2024' | '2025' | '2026'  (godina kreiranja)
   - type: 'grozdje' | 'rinfuza' | 'pretpakovine' | 'ocat'
   - cat:  (za grožđe: SORTA, za vino/mošt: kategorija)
   - info: 'bijelo' | 'crno' | 'roze' | '—'  (boja – za mošt/vino; kod grožđa može biti boja ili ništa)
   - qty: string s jedinicom: '10 t', '30 hl', '2200 l' (parsiramo)
   - dateTime: 'DD.MM.GGGG HH:MM' (radi filtera po year)
   - status: 'Aktivan' | 'Elektronički potpisan (pošiljatelj)' | 'Završen' | 'Storniran'
*/
const rows = [
  // 2024/2025 – miješano
  r('sender','1/2025','2024/2025','2025','grozdje','Graševina','bijelo','10 t','12.01.2025 09:12','Završen'),
  r('sender','2/2025','2024/2025','2025','rinfuza','vino','crno','30 hl','15.02.2025 11:47','Storniran'),
  r('receiver','3/2025','2024/2025','2025','pretpakovine','vino','bijelo','2200 l','20.02.2025 10:30','Aktivan'),
  r('receiver','4/2025','2024/2025','2025','ocat','Vinski ocat','—','5 hl','22.02.2025 14:12','Završen'),
  r('sender','5/2025','2024/2025','2025','grozdje','Plavac mali','crno','8.4 t','30.04.2025 18:20','Završen'),
  r('receiver','6/2025','2024/2025','2025','rinfuza','mošt','bijelo','12 hl','03.05.2025 10:05','Završen'),
  r('sender','7/2025','2024/2025','2025','rinfuza','vino','roze','15 hl','12.05.2025 12:45','Aktivan'),
  r('receiver','8/2025','2024/2025','2025','grozdje','Chardonnay','bijelo','5.2 t','18.05.2025 08:14','Elektronički potpisan (pošiljatelj)'),
  r('sender','9/2025','2024/2025','2025','rinfuza','vino','crno','70 hl','26.05.2025 16:59','Završen'),
  r('receiver','10/2025','2024/2025','2025','rinfuza','mošt','bijelo','6 hl','02.06.2025 09:40','Storniran'),
  r('sender','11/2025','2024/2025','2025','pretpakovine','vino','crno','1800 l','09.06.2025 11:00','Završen'),
  r('receiver','12/2025','2024/2025','2025','ocat','Vinski ocat','—','3 hl','15.06.2025 12:21','Aktivan'),
  r('sender','13/2025','2024/2025','2025','grozdje','Malvazija','bijelo','4.1 t','23.06.2025 07:50','Završen'),
  r('receiver','14/2025','2024/2025','2025','pretpakovine','vino','roze','900 l','28.06.2025 19:03','Elektronički potpisan (pošiljatelj)'),
  r('sender','15/2025','2024/2025','2025','rinfuza','vino','bijelo','22 hl','05.07.2025 13:33','Aktivan'),

  // 2023/2024
  r('sender','88/2024','2023/2024','2024','grozdje','Merlot','crno','6.7 t','12.03.2024 10:12','Završen'),
  r('receiver','92/2024','2023/2024','2024','rinfuza','vino','bijelo','18 hl','20.04.2024 09:56','Završen'),
  r('sender','96/2024','2023/2024','2024','pretpakovine','vino','crno','1200 l','28.05.2024 14:02','Storniran'),
  r('receiver','101/2024','2023/2024','2024','ocat','Vinski ocat','—','1.5 hl','11.06.2024 12:11','Aktivan'),
  r('sender','109/2024','2023/2024','2024','rinfuza','mošt','bijelo','9 hl','01.07.2024 17:20','Elektronički potpisan (pošiljatelj)'),

  // 2025/2026
  r('sender','1/2026','2025/2026','2025','grozdje','Frankovka','crno','3.2 t','05.08.2025 08:05','Aktivan'),
  r('receiver','2/2026','2025/2026','2025','rinfuza','vino','roze','11 hl','06.08.2025 10:26','Završen'),
  r('sender','3/2026','2025/2026','2025','pretpakovine','vino','bijelo','2600 l','07.08.2025 12:40','Završen'),
  r('receiver','4/2026','2025/2026','2025','rinfuza','vino','crno','25 hl','08.08.2025 16:12','Elektronički potpisan (pošiljatelj)'),
  r('sender','5/2026','2025/2026','2025','ocat','Vinski ocat','—','4 hl','09.08.2025 18:51','Aktivan'),
  r('receiver','6/2026','2025/2026','2025','grozdje','Pošip','bijelo','2.8 t','10.08.2025 09:03','Završen'),
  r('sender','7/2026','2025/2026','2025','rinfuza','vino','bijelo','44 hl','11.08.2025 07:32','Završen'),
  r('receiver','8/2026','2025/2026','2025','pretpakovine','vino','roze','700 l','12.08.2025 10:41','Storniran'),
  r('sender','9/2026','2025/2026','2025','rinfuza','mošt','bijelo','5 hl','13.08.2025 13:28','Završen'),
  r('receiver','10/2026','2025/2026','2025','grozdje','Graševina','bijelo','1.9 t','14.08.2025 15:47','Aktivan'),
  r('sender','11/2026','2025/2026','2025','pretpakovine','vino','crno','1600 l','15.08.2025 09:10','Završen'),
  r('receiver','12/2026','2025/2026','2025','ocat','Vinski ocat','—','2 hl','16.08.2025 11:20','Elektronički potpisan (pošiljatelj)'),
  r('sender','13/2026','2025/2026','2025','rinfuza','vino','crno','19 hl','17.08.2025 14:00','Aktivan')
];

function r(role,mvv,vg,year,type,cat,info,qty,dateTime,status){
  return { role, mvv, vg, year, type, cat, info, qty, dateTime, status,
           psName:(role==='sender'?'Vinarija/OPG Pošiljatelj':'—'),
           prName:(role==='receiver'?'Vinarija/OPG Primatelj':'—') };
}

/* ===== Helpers ===== */
const $=s=>document.querySelector(s);
const fmt=n=> (Math.round(n*100)/100).toLocaleString('hr-HR');
function badge(status){
  const c = status==='Aktivan'?'b-aktivan'
    : status==='Elektronički potpisan (pošiljatelj)'?'b-sender'
    : status==='Završen'?'b-finish'
    : 'b-storno';
  return `<span class="badge ${c}">${status}</span>`;
}
function vrstaLabel(code){
  return code==='grozdje'?'Grožđe'
      : code==='rinfuza'?'Vinski proizvod (rinfuza)'
      : code==='pretpakovine'?'Pretpakovine'
      : 'Vinski ocat';
}
function dodatniLabel(row){
  if(row.type==='grozdje') return row.info || row.cat || '—'; // boja ili sorta
  if(row.type==='rinfuza' || row.type==='pretpakovine') return row.info || '—'; // boja
  return '—';
}
function parseQty(q){
  // prihvaća "10 t", "8.4 t", "30 hl", "2200 l"
  const m = String(q).trim().match(/^([\d.,]+)\s*(t|hl|l)$/i);
  if(!m) return {val:0,u:'?'};
  let val = parseFloat(m[1].replace(',','.'));
  const u = m[2].toLowerCase();
  return {val,u};
}

/* Dostupne količine – Grožđe (informativno) */
const available = new Map([
  ['Graševina', 245.6],
  ['Riesling', 90.2],
  ['Plavac mali', 12.0],
  ['Malvazija', 7.0],
  ['Chardonnay', 18.5],
  ['Merlot', 23.7],
  ['Pošip', 9.4],
  ['Frankovka', 11.9]
]);

/* ===== Render listova ===== */
function currentFilter(){
  const fy = $('#fYear').value;
  const vg = $('#fWine').value;
  const tp = $('#fType').value;
  const st = $('#fStatus').value;
  const ref = ($('#fRef').value||'').toLowerCase();

  const pass = r =>
    (!fy || r.year===fy) &&
    (!vg || r.vg===vg) &&
    (!tp || r.type===tp) &&
    (!st || r.status===st) &&
    (!ref || r.mvv.toLowerCase().includes(ref) || (r.psName&&r.psName.toLowerCase().includes(ref)) || (r.prName&&r.prName.toLowerCase().includes(ref)));

  return {
    senders: rows.filter(x=>x.role==='sender' && pass(x)),
    receivers: rows.filter(x=>x.role==='receiver' && pass(x)),
    all: rows.filter(pass)
  };
}

function renderTables(){
  const f = currentFilter();

  const tS = $('#tblS tbody');
  const tR = $('#tblR tbody');

  tS.innerHTML = f.senders.length
    ? f.senders.map(rowToTr).join('')
    : `<tr><td colspan="7" class="hint">Nema podataka</td></tr>`;

  tR.innerHTML = f.receivers.length
    ? f.receivers.map(rowToTr).join('')
    : `<tr><td colspan="7" class="hint">Nema podataka</td></tr>`;

  $('#hintS').textContent = f.senders.length ? '' : 'Pokušaj promijeniti filtere iznad.';
  $('#hintR').textContent = f.receivers.length ? '' : 'Pokušaj promijeniti filtere iznad.';

  renderAggregates(f.all);
  renderAvailable();
}

function rowToTr(r){
  return `<tr>
    <td>${r.mvv}</td>
    <td>${vrstaLabel(r.type)}</td>
    <td>${r.type==='grozdje'? (r.cat||'—') : (r.cat||'—')}</td>
    <td>${dodatniLabel(r)}</td>
    <td>${r.qty}</td>
    <td>${r.dateTime}</td>
    <td>${badge(r.status)}</td>
  </tr>`;
}

/* ===== Zbirni pregledi ===== */
function renderAggregates(list){
  // Grožđe – po sortama u tonama
  const g = new Map(); // key=sorta, {ton, count}
  list.forEach(r=>{
    if(r.type!=='grozdje') return;
    const {val,u} = parseQty(r.qty);
    const tons = u==='t' ? val : (u==='kg' ? val/1000 : 0);
    const key = r.cat || '—';
    const prev = g.get(key) || {ton:0,count:0};
    g.set(key, {ton: prev.ton + tons, count: prev.count + 1});
  });
  const gBody = $('#sumG tbody');
  gBody.innerHTML = '';
  if(!g.size){
    gBody.innerHTML = '<tr><td>—</td><td>0</td><td>0</td></tr>';
  } else {
    for(const [sorta, obj] of g){
      gBody.insertAdjacentHTML('beforeend', `<tr><td>${sorta}</td><td>${fmt(obj.ton)}</td><td>${obj.count}</td></tr>`);
    }
  }

  // Mošt/Vino – hl (crno/roze i bijelo) + broj ePD-ova (po vrsti)
  const mv = {
    vino: {cr:0, bi:0, cnt:0},
    most: {cr:0, bi:0, cnt:0},
  };
  const seenMV = {vino:0, most:0}; // broj ePD (jedinstveno po dokumentu/retku)
  list.forEach(r=>{
    if(r.type!=='rinfuza' && r.type!=='pretpakovine') return;
    const kind = (r.cat||'').toLowerCase().includes('mošt') ? 'most' : 'vino';
    const {val,u} = parseQty(r.qty);
    const hl = u==='hl' ? val : (u==='l' ? val/100 : 0);
    if(['crno','roze'].includes((r.info||'').toLowerCase())){
      mv[kind].cr += hl;
    } else {
      // bijelo ili nepoznato -> tretiramo kao bijelo
      mv[kind].bi += hl;
    }
    mv[kind].cnt += 1;
  });

  const mvBody = $('#sumMV tbody');
  mvBody.innerHTML = '';
  ['vino','most'].forEach(k=>{
    if(mv[k].cr>0 || mv[k].bi>0 || mv[k].cnt>0){
      mvBody.insertAdjacentHTML('beforeend',
        `<tr><td>${k==='vino'?'Vino':'Mošt'}</td><td>${fmt(mv[k].cr)}</td><td>${fmt(mv[k].bi)}</td><td>${mv[k].cnt}</td></tr>`);
    }
  });
  if(!mvBody.children.length){
    mvBody.innerHTML = '<tr><td>—</td><td>0</td><td>0</td><td>0</td></tr>';
  }

  // Vinski ocat – hl + broj ePD-ova
  let oHl = 0, oCnt = 0;
  list.forEach(r=>{
    if(r.type!=='ocat') return;
    const {val,u} = parseQty(r.qty);
    const hl = u==='hl' ? val : (u==='l' ? val/100 : 0);
    oHl += hl; oCnt += 1;
  });
  const oBody = $('#sumOcat tbody');
  oBody.innerHTML = `<tr><td>Vinski ocat</td><td>${fmt(oHl)}</td><td>${oCnt}</td></tr>`;
}

/* ===== Dostupne količine – Grožđe (informativno) ===== */
function renderAvailable(){
  const tb = $('#availG tbody');
  tb.innerHTML = '';
  for(const [sorta, koli] of available.entries()){
    tb.insertAdjacentHTML('beforeend', `<tr><td>${sorta}</td><td>${fmt(koli)}</td></tr>`);
  }
}

/* ===== Events ===== */
$('#btnSearch').onclick = renderTables;
$('#btnReset').onclick = ()=>{
  $('#fYear').value='';
  $('#fWine').value='2024/2025';
  $('#fType').value='';
  $('#fStatus').value='';
  $('#fRef').value='';
  renderTables();
};

/* INIT */
renderTables();
</script>
</body>
</html>
